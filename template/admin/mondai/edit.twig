{% extends 'admin/_layout.twig' %}

{% block admin_body %}
    <script src="/script/happy.js"></script>
    <h2>Редактирование задачи</h2>
    {% if errors %}
        <ul class="error">
            {% for error in errors %}
                <li>
                    {% if error == 'CSRF' %}
                        Попытка взлома.
                    {% elseif error == 'MONDAI_ID:ALREADY_EXISTS' %}
                        Задача №{{ mondai.mondai_id }} уже существует.
                    {% elseif error == 'MONDAI_ID:NOT_A_NUMBER' %}
                        Номер задачи должен быть положительным целым числом.
                    {% elseif error == 'TITLE:EMPTY' %}
                        Заголовок задачи не должен быть пустым.
                    {% elseif error == 'CONTENT:EMPTY' %}
                        Описание задачи не должно быть пустым.
                    {% else %}
                        Ошибка {{ error }}.
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% endif %}
    <form
        id="admin_mondai_edit"
        action="{{ path('admin_mondai_edit', { 'mondai_id' : mondai_id }) }}?page={{ page }}"
        method="post"
    >
        <input type="hidden" name="csrf" value="{{ csrf }}"/>
        <p>№<input name="mondai_id" required value="{{ mondai.mondai_id }}" maxlength="3"/>.
            <input name="title"     required value="{{ mondai.title }}"/>
            <label>
                <input
                    type="checkbox"
                    name="is_hidden"
                    value="1"
                    {% if mondai.is_hidden == 1 %}
                        checked
                    {% endif %}
                />
                (скрыта)
            </label>
        </p>
        <p>
            Сдача:
            <select name="kyoku">
                {% for kyoku in KYOKUS %}
                    <option
                        value="{{ kyoku }}"
                        {% if kyoku == mondai.content.kyoku %}
                            selected
                        {% endif %}
                    >
                        {{ kyoku|kyoku }}
                    </option>
                {% endfor %}
            </select>
        </p>
        <p>
            Позиция:
            <select name="jikaze">
                {% for kaze in KAZES %}
                    <option
                        value="{{ kaze }}"
                        {% if kaze == mondai.content.jikaze %}
                            selected
                        {% endif %}
                    >
                        {{ kaze|kaze }}
                    </option>
                {% endfor %}
            </select>
        </p>
        <p>Ход: <input name="junme" required value="{{ mondai.content.junme }}" maxlength="2"/></p>
        <p>
            Дора:
            <select name="dora">
                {% for pai in PAIS %}
                    <option
                        value="{{ pai }}"
                        {% if pai == mondai.content.dora %}
                            selected
                        {% endif %}
                    >
                        {{ pai }}
                    </option>
                {% endfor %}
            </select>
        </p>
        
        {#
            <div class="mochiten">Очки:    {{ mondai.content.mochiten       }}</div>
            <div class="tehai"   >Рука:    {{ mondai.content.tehai |pai|raw }}</div>
            <div class="tsumo"   >Набрал:  {{ mondai.content.tsumo |pai|raw }}</div>
            <div class="question">Варианты ответа:</div>
            <ol  class="variants" style="list-style-type: upper-alpha">
                <li>{{ mondai.content.kiri_a|pai|raw }}</li>
                <li>{{ mondai.content.kiri_b|pai|raw }}</li>
                <li>{{ mondai.content.kiri_c|pai|raw }}</li>
            </ol>
        #}
        <p>
            <input type="submit" name="save" value="Сохранить"/>
            {% if mondai_id == 'new' %}
                {% set cancel = path('admin_page', { 'page' : page }) %}
            {% else %}
                {% set cancel = path('admin_mondai_view', { 'mondai_id' : mondai_id }) ~ '?page=' ~ page %}
            {% endif %}
            <input type="button" onclick="location = '{{ cancel }}'" value="Отмена"/>
            {% if mondai_id != 'new' %}
                <input
                    type="submit" name="delete"  value="Удалить"
                    onclick="return window.confirm('После удаления задача не может быть восстановлена.\n\nУдалить задачу?')"
                />
            {% endif %}
        </p>
    </form>
    <script>
        $('#admin_mondai_edit').isHappy({
            fields : {
                'input[name=mondai_id]' : {
                    required : true,
                    message  : 'Номер должен быть целым положительным числом',
                    test : function checkMondaiId(mondaiId) {
                        return !! (mondaiId + '').match(/^\d{1,3}$/) && parseInt(mondaiId, 10) > 0;
                    }
                },
                'input[name=junme]' : {
                    required : true,
                    message  : 'Номер хода должен быть числом от 1 до 18',
                    test : function checkJunme(junme) {
                        if (! (junme + '').match(/^\d{1,2}$/)) {
                            return false;
                        }
                        var parsed = parseInt(junme, 10);
                        return parsed >= 1 && parsed <= 18;
                    }
                },
                'input[name=title]' : {
                    required : true,
                    message  : 'Заголовок должен быть не пуст'
                }
            }
        });
    </script>
{% endblock %}
